/*!
 * vue-pleasure v1.0.0
 * (c) 2018-2019 Martin Rafael Gonzalez <tin@devtin.io>
 * Released under the MIT License.
 */
var VuePleasure=function(a,b,c,d,e,f,g,h,i,j,k,l,m){'use strict';function n(a,{app:b,store:c,noCoerce:d=!1}={}){if(c?c.registerModule("pleasure",I):(a.use(l),c=new l.Store({modules:{pleasure:I}})),!process.server){const a=new J,b=async()=>{a.clearAll(),await c.dispatch("pleasure/syncEntities")};h.cache(a),h.on("logout",b),h.on("login",b)}h.on("login",a=>{c.commit("pleasure/setUser",a)}),h.on("logout",()=>{c.commit("pleasure/setUser",null)}),d||(console.log(`enabling coerce`),a.mixin(k)),a.mixin({components:{pleasure:D},filters:{lang(a){return a}},computed:{$pleasure(){const a=this;return{error(b){a.$message({message:b,type:"error"})},api:h,settings:c.getters["pleasure/settings"],dropdown:c.getters["pleasure/dropdown"],entities:c.getters["pleasure/entities"],user:c.getters["pleasure/user"]}}}}),h.on("profile-update",a=>{c.dispatch("pleasure/changeUserProfile",a)}),process.server||c.dispatch("pleasure/syncEntities")}b=b&&b.hasOwnProperty("default")?b["default"]:b,c=c&&c.hasOwnProperty("default")?c["default"]:c,d=d&&d.hasOwnProperty("default")?d["default"]:d,e=e&&e.hasOwnProperty("default")?e["default"]:e,f=f&&f.hasOwnProperty("default")?f["default"]:f,g=g&&g.hasOwnProperty("default")?g["default"]:g,h=h&&h.hasOwnProperty("default")?h["default"]:h,i=i&&i.hasOwnProperty("default")?i["default"]:i,j=j&&j.hasOwnProperty("default")?j["default"]:j,k=k&&k.hasOwnProperty("default")?k["default"]:k,l=l&&l.hasOwnProperty("default")?l["default"]:l,m=m&&m.hasOwnProperty("default")?m["default"]:m;var o={props:{i18nScope:{type:String,default:null},formId:{type:String,required:!0},disabled:{type:Boolean,default:!1}},computed:{formComponent(){return"el-form"}}},p=function(a,b,c,d,e,f,g,h,i,j){"boolean"!=typeof g&&(i=h,h=g,g=!1);var k="function"==typeof c?c.options:c;a&&a.render&&(k.render=a.render,k.staticRenderFns=a.staticRenderFns,k._compiled=!0,e&&(k.functional=!0)),d&&(k._scopeId=d);var l;if(f?(l=function(a){a=a||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext,a||"undefined"==typeof __VUE_SSR_CONTEXT__||(a=__VUE_SSR_CONTEXT__),b&&b.call(this,i(a)),a&&a._registeredComponents&&a._registeredComponents.add(f)},k._ssrRegister=l):b&&(l=g?function(){b.call(this,j(this.$root.$options.shadowRoot))}:function(a){b.call(this,h(a))}),l)if(k.functional){var m=k.render;k.render=function(a,b){return l.call(b),m(a,b)}}else{var n=k.beforeCreate;k.beforeCreate=n?[].concat(n,l):[l]}return c};var q=function(){var a=this,b=a.$createElement,c=a._self._c||b;return c("div",{staticClass:"pleasure-form"},[c(a.formComponent,{key:a.formId,tag:"component",on:{input:function(b){return a.$emit("input",b)}}},[a._t("default")],2)],1)};q._withStripped=!0;var r=p({render:q,staticRenderFns:[]},void 0,o,void 0,!1,void 0,void 0,void 0),s={props:{i18nScope:{type:String,default:null},field:{type:Object,required:!0}},computed:{theProps(){const a={};return"array"===this.componentType&&Object.assign(a,{options:this.field.enumValues}),Object.assign({},this.$props,a,get(this.field,"$pleasure",{}))},fieldContainer(){return"element-ui"===this.$pleasure.settings.ui?"el-form-item":"div"}}};var t=function(){var a=this,b=a.$createElement,c=a._self._c||b;return c("div",{staticClass:"pleasure-field-container"},[c(a.fieldContainer,{tag:"component",attrs:{required:a.field.$pleasure.required,disabled:a.field.$pleasure.disabled,label:a.field.$pleasure.label}},[a._t("default")],2)],1)};t._withStripped=!0;var u=p({render:t,staticRenderFns:[]},void 0,s,void 0,!1,void 0,void 0,void 0),v={props:{i18nScope:{type:String,default:null},formValues:{type:Object,default:void 0},value:{type:[Number,Boolean,String,Object,Array],default:null},field:{type:Object,required:!0}},computed:{theProps(){const a={};return"array"===this.componentType&&Object.assign(a,{options:this.field.enumValues}),Object.assign({},this.$props,a,e(this.field,"$pleasure",{}))},componentType(){return this.field.enumValues&&0<this.field.enumValues.length||"Array"===this.field.instance?"array":"input"},fieldComponent(){switch(this.componentType){case"array":return"pleasure-select";default:return"el-input";}}}};var w=function(){var a=this,b=a.$createElement,c=a._self._c||b;return c("div",{staticClass:"pleasure-field"},[c(a.fieldComponent,a._b({tag:"component",attrs:{name:a.field.path},on:{input:function(b){return a.$emit("input",b||null)}}},"component",a.theProps,!1))],1)};w._withStripped=!0;var x=p({render:w,staticRenderFns:[]},void 0,v,void 0,!1,void 0,void 0,void 0),y={props:{actionCallback:{type:Function,default(){}},cancelCallback:{type:Function,default(){}},actionLabel:{type:String,default:"Create"},cancelLabel:{type:String,default:"Cancel"},formVisible:{type:Boolean,default:!0},actionDisabled:{type:Boolean,default:!1},loading:{type:Boolean,default:!1},loadingText:{type:String,default:`messages.loading`},method:{type:String,required:!0},cancelable:{type:Boolean,required:!0}}};var z=function(){var a=this,b=a.$createElement,c=a._self._c||b;return c("div",{staticClass:"pleasure-form-controls"},[a.formVisible?c("el-button",{staticClass:"full-btn",attrs:{name:"update"===a.method?"update":"create",disabled:a.actionDisabled,loading:a.loading,type:"primary","native-type":"submit"},nativeOn:{click:function(b){return b.preventDefault(),a.actionCallback(b)}}},[a._v("\n    "+a._s(a._f("lang")(a.actionLabel))+"\n  ")]):a._e(),a._v(" "),a.cancelable?c("el-button",{staticClass:"full-btn",nativeOn:{click:function(b){return b.preventDefault(),a.cancelCallback(b)}}},[a._v("\n    "+a._s(a.cancelLabel)+"\n  ")]):a._e()],1)};z._withStripped=!0;var A=p({render:z,staticRenderFns:[]},void 0,y,void 0,!1,void 0,void 0,void 0),B={components:{PleasureForm:r,PleasureFieldContainer:u,PleasureField:x,PleasureFormControls:A},props:{omit:{type:Array,default(){return[]}},guessLabel:{type:Boolean,default:!0},guessPlaceholder:{type:Boolean,default:!0},actionLabel:{type:String,default:"Create"},autoLabelI18n:{type:Boolean,default:!0},autoPlaceholderI18n:{type:Boolean,default:!0},withControls:{type:Boolean,default:!0},i18nScope:{type:String,default:null,coerce(...a){return console.log(`coercing`,...a),console.log(`coercing>>>`,this.i18nScope,this.entity),this.i18nScope?this.i18nScope:this.entity||"default"}},cancelLabel:{type:String,default:"Cancel"},method:{type:String,default:"create"},cancelable:{type:Boolean,default:!0},value:{type:Object,default(){return{}}},formName:{type:String,default:null},entity:{type:String,default:null},entryId:{type:String,default:null},partialUpdate:{type:Boolean,default:!1},customSchema:{type:Object,default:null},login:{type:Boolean,default:!1},autoload:{type:Boolean,default:!0}},data(){return{componentWrapper:"el-form-item",values:g.all([this.values||{},this.value]),formId:"an-id",entryRead:!1,disabled:!1}},computed:{loaded(){return this.schema&&(!this.autoload||this.autoload&&this.entryRead)},schema(){if(!this.customSchema&&(!this.entity||!this.$pleasure.entities||!this.$pleasure.entities[this.entity]))return[];const a=this.customSchema||this.$pleasure.entities[this.entity],c=[];return b(a,(a,b)=>/^_/.test(b)||e(a,"options.options.virtual")||0<=this.omit.indexOf(b)?void console.log(`skipping`,{fieldName:b}):void c.push(this.toPleasureField(f(a,{path:b})))),c}},watch:{values:{handler(a){this.$emit("input",a)},deep:!0}},async mounted(){if(this.autoload){if(this.entryId)try{this.$set(this,"values",(await this.$pleasure.api.read(this.entity,this.entryId)))}catch(a){this.$pleasure.error(a.message)}this.entryRead=!0}},methods:{onCancel(){},toPleasureField(a){const b=c(a.path),e=[this.i18nScope?`${this.i18nScope}.placeholder.${b}`:null,this.i18nScope?`${this.i18nScope}.${b}`:null,`placeholders.${b}`].filter(a=>!!a),g=[this.i18nScope?`${this.i18nScope}.label.${b}`:null,this.i18nScope?`${this.i18nScope}.${b}`:null,`labels.${b}`].filter(a=>!!a);return a=f(a,{$pleasure:{}}),!a.$pleasure.label&&this.guessLabel&&(a.$pleasure.label=d(a.path)),!a.$pleasure.placeholder&&this.guessPlaceholder&&(a.$pleasure.placeholder=d(a.path)),this.autoLabelI18n&&(a.$pleasure.label=this.plsi18n(g,a.$pleasure.label)),this.autoPlaceholderI18n&&(a.$pleasure.placeholder=this.plsi18n(e,a.$pleasure.placeholder)),a},performSubmit(){switch(this.method){case"create":return this.$pleasure.api.create(this.entity,this.values);case"update":return this.$pleasure.api.update(this.entity,this.entryId,this.values);}},async onSubmit(){try{this.login?await this.$pleasure.api.login(this.values):await this.performSubmit()}catch(a){this.$pleasure.error(a.message)}}}};var C=function(){var a=this,b=a.$createElement,c=a._self._c||b;return c("div",{staticClass:"pleasure"},[c("pleasure-form",{attrs:{disabled:a.disabled,"form-id":a.formId,"i18n-scope":a.i18nScope}},[a.loaded?a._l(a.schema,function(b){return c("pleasure-field-container",{key:a.formId+"-"+b.path,attrs:{"i18n-scope":a.i18nScope,field:b}},[c("pleasure-field",{attrs:{field:b,"i18n-scope":a.i18nScope,"form-values":a.values},model:{value:a.values[b.path],callback:function(c){a.$set(a.values,b.path,c)},expression:"values[field.path]"}})],1)}):a._e(),a._v(" "),a._t("default"),a._v(" "),a.loaded&&a.withControls?c("pleasure-form-controls",{attrs:{"v-bind":a.$props,"action-label":a.actionLabel,"cancel-label":a.cancelLabel,"action-callback":a.onSubmit,"cancel-callback":a.onCancel,cancelable:a.cancelable,method:a.method}}):a._e()],2)],1)};C._withStripped=!0;var D=p({render:C,staticRenderFns:[]},void 0,B,void 0,!1,void 0,void 0,void 0);const E={entitiesSync:0,entitiesSchema:{},dropdown:{},settings:process.env.$pleasure.settings,dropdownLoading:[],user:null,locales:["en","es"],locale:"en"},F={setLocale(a,b){a.locale=b},setDropdownLoading(a,b){0>a.dropdownLoading.indexOf(b)&&a.dropdownLoading.push(b)},removeDropdownLoading(a,b){a.dropdownLoading.splice(a.dropdownLoading.indexOf(b),1)},setUser(a,b){i.set(a,"user",b)},setEntitiesSync(a,b){i.set(a,"entitiesSync",b)},setEntitiesSchema(a,c){b(c,a=>{b(a,a=>{f(a,{$pleasure:{}})})}),i.set(a,"entitiesSchema",c)},setDropdown(a,{dropdownName:b,results:c}){console.log(`setting dropdown`,{dropdownName:b,results:c}),i.set(a.dropdown,b,c)}},G={changeUserProfile({commit:a},b){return a("setUser",b)},async locale({commit:a},b){a("setlocale",b)},async loadDropdown({commit:a,state:b},{entity:c,listOptions:d,name:e,force:f=!1}={}){const g=c||e,i=j({entity:c,listOptions:d,dropdownName:g});if(!(0<=b.dropdownLoading.indexOf(i))){if(console.log(`load dropdown`),!f&&b.dropdown[g])return b.dropdown[g];a("setDropdownLoading",i);const e=await h.list(c,d);return a("setDropdown",{dropdownName:g,results:e}),a("removeDropdownLoading",i),e}},logout(){return h.logout()},async syncEntities({commit:a,state:b},{force:c=!1}={}){if(!c&&0!==b.entitiesSync)return;a("setEntitiesSync",-1);let d;try{d=await h.getEntities()}catch(b){return a("setEntitiesSync",0),void console.log(`Could not retrieve entities`,b.message)}a("setEntitiesSchema",d),a("setEntitiesSync",1)}},H={entities(a){return a.entitiesSchema},dropdown(a){return a.dropdown},settings(a){return a.settings},user(a){return a.user}};var I=Object.freeze({namespaced:!0,state:E,mutations:F,actions:G,getters:H});class J{constructor({scope:b="pleasure",store:a,lifetime:c=1800}={}){this._store=a||window.sessionStorage,this._lifetime=1e3*c,this._scope=b,this._cached=[]}scope(a){return`${this._scope}-${a}`}req({id:a}){if(a){const b=this._store.getItem(this.scope(a));if(b){const{cached:c,res:d}=JSON.parse(b);return c+this._lifetime<=Date.now()?void this.clear(a):d}}}res({id:a,req:b,res:c}){if("undefined"!=typeof c&&"get"===b.method)return this._cached.push(a),this._store.setItem(this.scope(a),JSON.stringify({cached:Date.now(),res:c})),c}clear(a){this._store.removeItem(this.scope(a)),this._cached.splice(this._cached.indexOf(a),1)}clearAll(){for(;0<this._cached.length;)this.clear(this._cached[0])}}return a.install=n,a}({},forOwn,kebabCase,startCase,get$1,defaults,merge,pleasureClient,Vue,objectHash,CoercePropsMixin,Vuex,vueI18n);
